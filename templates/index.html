<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <title>SmartLink æ§åˆ¶å°ï¼ˆWindows ç‰ˆï¼‰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { padding:20px; background:#f6fbff; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; color:#0f2333; }
      .card-panel { background:#fff; border-radius:10px; box-shadow:0 4px 12px rgba(30,144,255,0.08); padding:16px; }
      .section-title { color:#1e90ff; font-weight:700; margin-bottom:10px; }
      .item-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:15px; }
      .item-card { border:1px solid rgba(30,144,255,0.1); border-radius:8px; padding:12px; background:#fff; position:relative; transition:all 0.2s; }
      .item-card:hover { box-shadow:0 4px 10px rgba(0,0,0,0.08); }
      .card-buttons { position:absolute; top:10px; right:10px; display:flex; gap:5px; }
      .btn-circle { border-radius:50%; width:28px; height:28px; display:flex; align-items:center; justify-content:center; }
    </style>
  </head>
  <body>
    <div class="container-fluid">

      <!-- é¡µé¢å¤§æ ‡é¢˜ -->
      <div class="mb-4 text-center">
        <h1 class="fw-bold" style="color:#1e90ff;">SmartLink æ§åˆ¶å°ï¼ˆWindows ç‰ˆï¼‰</h1>
      </div>

      <!-- é¡¶éƒ¨ä¸¤å¼ å¡ç‰‡ -->
      <div class="row mb-3 g-3">
        <div class="col-md-6">
          <div class="card-panel h-100 d-flex flex-column justify-content-between">
            <div class="section-title">MQTT UID(ç§˜é’¥ï¼‰é…ç½®</div>
            <form method="POST" action="{{ url_for('main.save_mqtt_uid') }}" class="d-flex gap-2 mt-2">
              <input type="text" class="form-control" name="mqtt_uid" placeholder="è¾“å…¥ MQTT UID" value="{{ settings.mqtt_uid }}">
              <button class="btn btn-primary">ä¿å­˜</button>
            </form>
<!--            &lt;!&ndash; å½“å‰ UID å°å­—æ˜¾ç¤º &ndash;&gt;-->
<!--            <div class="small text-muted mt-2">å½“å‰ UID: {{ settings.mqtt_uid or 'æœªè®¾ç½®' }}</div>-->
          </div>
        </div>


        <div class="col-md-6">
          <div class="card-panel h-100 d-flex flex-column justify-content-between">
            <div>
              <div class="section-title mb-1">å¯åŠ¨é¡¹ç®¡ç†</div>
              <div class="text-muted small">å¯æ·»åŠ æˆ–ç¼–è¾‘ç³»ç»Ÿå¯åŠ¨ä»»åŠ¡</div>
            </div>
            <button class="btn btn-success mt-2" data-bs-toggle="modal" data-bs-target="#editModal">ï¼‹ æ·»åŠ å¯åŠ¨é¡¹</button>
          </div>
        </div>
      </div>

      <!-- å¯åŠ¨é¡¹åˆ—è¡¨ -->
      <div class="card-panel">
        <div class="section-title">å¯åŠ¨é¡¹åˆ—è¡¨</div>
        {% if items|length == 0 %}
          <div class="alert alert-warning">æš‚æ— å¯åŠ¨é¡¹ã€‚</div>
        {% else %}
          <div class="item-grid">
            {% for name, info in items %}
              <div class="item-card">
                <div class="card-buttons">
                  <button class="btn btn-outline-primary btn-sm btn-circle edit-btn" data-name="{{ name }}">âœï¸</button>
                  <form method="POST" action="{{ url_for('main.delete_item', name=name) }}" onsubmit="return confirm('ç¡®å®šåˆ é™¤ {{ name }}?');">
                    <button class="btn btn-outline-danger btn-sm btn-circle">ğŸ—‘ï¸</button>
                  </form>
                </div>
                <h5 class="fw-bold mb-1">{{ name }}</h5>
                <div class="small text-muted">Topic: {{ info.bafy_topic or '-' }}</div>
                <div class="small text-muted">ç±»å‹: {{ info.cmd or 'cmd' }}</div>
                <div class="small text-muted">å‚æ•°: {{ info.para or '-' }}</div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="text-center mt-4 small text-secondary">SmartLink Web Â© 2025</div>
    </div>

    <!-- ç¼–è¾‘/æ·»åŠ  æ¨¡æ€æ¡† -->
    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form method="POST" action="{{ url_for('main.save_item') }}" id="editForm">
            <div class="modal-header">
              <h5 class="modal-title">ç¼–è¾‘å¯åŠ¨é¡¹</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="old_name" id="old_name">
              <div class="mb-3">
                <label class="form-label">åç§°</label>
                <input type="text" class="form-control" name="name" id="item_name" required>
              </div>
              <div class="mb-3">
                <label class="form-label">å·´æ³•äº‘ Topic</label>
                <input type="text" class="form-control" name="bafy_topic" id="item_bafy_topic">
              </div>
              <div class="mb-3">
                <label class="form-label">ç±»å‹</label>
                <input type="text" class="form-control" name="cmd" id="item_cmd" placeholder="cmd">
              </div>
              <div class="mb-3">
                <label class="form-label">å‚æ•°</label>
                <input type="text" class="form-control" name="para" id="item_para" placeholder="å¯ç•™ç©º">
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary">ä¿å­˜</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      var map = {{ item_json_map|tojson }};

      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.onclick = () => {
          const name = btn.dataset.name;
          if(map[name]){
            const info = JSON.parse(map[name]);
            document.getElementById("item_name").value = name;
            document.getElementById("item_bafy_topic").value = info.bafy_topic || "";
            document.getElementById("item_cmd").value = info.cmd || "cmd";
            document.getElementById("item_para").value = info.para || "";
            document.getElementById("old_name").value = name;
            new bootstrap.Modal(document.getElementById("editModal")).show();
          }
        };
      });
    </script>
  </body>
</html>
